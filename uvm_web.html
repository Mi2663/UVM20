<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£–í–ú - Web –≤–µ—Ä—Å–∏—è</title>
    <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
    <script defer src="https://pyscript.net/latest/pyscript.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .editor-section, .output-section {
            margin-bottom: 30px;
        }
        
        textarea {
            width: 100%;
            height: 200px;
            font-family: 'Consolas', monospace;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin: 10px 0;
            flex-wrap: wrap;
        }
        
        button {
            padding: 10px 20px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #2980b9;
        }
        
        button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }
        
        .output {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            font-family: 'Consolas', monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 15px;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: 1px solid transparent;
            border-bottom: none;
            border-radius: 5px 5px 0 0;
        }
        
        .tab.active {
            background: #3498db;
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .status-bar {
            margin-top: 20px;
            padding: 10px;
            background: #ecf0f1;
            border-radius: 5px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéÆ –£—á–µ–±–Ω–∞—è –í–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è –ú–∞—à–∏–Ω–∞ (Web –≤–µ—Ä—Å–∏—è)</h1>
        
        <div class="editor-section">
            <h3>–†–µ–¥–∞–∫—Ç–æ—Ä –ø—Ä–æ–≥—Ä–∞–º–º—ã (JSON)</h3>
            <textarea id="code-editor">{
  "program": [
    {
      "opcode": "LOAD_CONST",
      "operand": 520,
      "comment": "–¢–µ—Å—Ç: A=10, B=520"
    },
    {
      "opcode": "LOAD_MEM",
      "operand": 133,
      "comment": "–¢–µ—Å—Ç: A=0, B=133"
    },
    {
      "opcode": "STORE_MEM",
      "operand": 167,
      "comment": "–¢–µ—Å—Ç: A=14, B=167"
    },
    {
      "opcode": "SQRT",
      "operand": 954,
      "comment": "–¢–µ—Å—Ç: A=2, B=954"
    }
  ]
}</textarea>
            
            <div class="button-group">
                <button py-click="assemble()">–ê—Å—Å–µ–º–±–ª–∏—Ä–æ–≤–∞—Ç—å</button>
                <button py-click="run()">–í—ã–ø–æ–ª–Ω–∏—Ç—å</button>
                <button py-click="load_example()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–∏–º–µ—Ä</button>
                <button py-click="clear_editor()">–û—á–∏—Å—Ç–∏—Ç—å</button>
            </div>
        </div>
        
        <div class="output-section">
            <div class="tabs">
                <div class="tab active" onclick="switchTab('output')">–í—ã–≤–æ–¥</div>
                <div class="tab" onclick="switchTab('memory')">–ü–∞–º—è—Ç—å</div>
                <div class="tab" onclick="switchTab('help')">–°–ø—Ä–∞–≤–∫–∞</div>
            </div>
            
            <div id="output-tab" class="tab-content active">
                <div id="output" class="output">–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ...</div>
            </div>
            
            <div id="memory-tab" class="tab-content">
                <div id="memory" class="output">–ü–∞–º—è—Ç—å –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∞ –∑–¥–µ—Å—å...</div>
            </div>
            
            <div id="help-tab" class="tab-content">
                <div class="output">
–ö–û–ú–ê–ù–î–´ –£–í–ú:

1. LOAD_CONST <value>
   –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∫–æ–Ω—Å—Ç–∞–Ω—Ç—É –≤ –∞–∫–∫—É–º—É–ª—è—Ç–æ—Ä

2. LOAD_MEM <offset>
   –ß–∏—Ç–∞–µ—Ç –∏–∑ –ø–∞–º—è—Ç–∏: ACC = MEM[ACC + offset]

3. STORE_MEM <address>
   –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤ –ø–∞–º—è—Ç—å: MEM[address] = ACC

4. SQRT <address>
   –í—ã—á–∏—Å–ª—è–µ—Ç –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã–π –∫–æ—Ä–µ–Ω—å: MEM[address] = sqrt(MEM[ACC])

–§–û–†–ú–ê–¢ –ü–†–û–ì–†–ê–ú–ú–´ (JSON):
{
  "program": [
    {"opcode": "LOAD_CONST", "operand": 100},
    {"opcode": "STORE_MEM", "operand": 500}
  ]
}
                </div>
            </div>
        </div>
        
        <div class="status-bar">
            –°—Ç–∞—Ç—É—Å: <span id="status">–ì–æ—Ç–æ–≤</span>
        </div>
    </div>

    <py-config>
        packages = []
        [[fetch]]
        files = ["./uvm_asm.py", "./uvm_interp.py"]
    </py-config>

    <py-script>
import js
import json
import traceback
from pyodide.ffi import create_proxy

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –º–æ–¥—É–ª–∏ –£–í–ú
try:
    from uvm_asm import UVMAssembler
    from uvm_interp import UVMInterpreter
    HAS_MODULES = True
except ImportError:
    HAS_MODULES = False
    print("–ú–æ–¥—É–ª–∏ –£–í–ú –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –†–∞–±–æ—Ç–∞ –≤ –¥–µ–º–æ-—Ä–µ–∂–∏–º–µ.")

def update_status(message):
    """–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å"""
    js.document.getElementById("status").innerText = message

def log_output(message, clear=False):
    """–ó–∞–ø–∏—Å–∞—Ç—å –≤—ã–≤–æ–¥"""
    output = js.document.getElementById("output")
    if clear:
        output.innerText = ""
    
    import datetime
    timestamp = datetime.datetime.now().strftime("%H:%M:%S")
    output.innerText += f"[{timestamp}] {message}\n"
    output.scrollTop = output.scrollHeight

def update_memory(dump_data):
    """–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–º–ø –ø–∞–º—è—Ç–∏"""
    memory = js.document.getElementById("memory")
    memory.innerText = ""
    
    if isinstance(dump_data, dict):
        for addr, value in sorted(dump_data.items(), key=lambda x: int(x[0])):
            memory.innerText += f"MEM[{addr}] = {value}\n"
    elif isinstance(dump_data, str):
        memory.innerText = dump_data

def load_example():
    """–ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–∏–º–µ—Ä –ø—Ä–æ–≥—Ä–∞–º–º—ã"""
    example = '''{
  "program": [
    {
      "opcode": "LOAD_CONST",
      "operand": 520,
      "comment": "–¢–µ—Å—Ç: A=10, B=520"
    },
    {
      "opcode": "LOAD_MEM",
      "operand": 133,
      "comment": "–¢–µ—Å—Ç: A=0, B=133"
    },
    {
      "opcode": "STORE_MEM",
      "operand": 167,
      "comment": "–¢–µ—Å—Ç: A=14, B=167"
    },
    {
      "opcode": "SQRT",
      "operand": 954,
      "comment": "–¢–µ—Å—Ç: A=2, B=954"
    }
  ]
}'''
    
    js.document.getElementById("code-editor").value = example
    log_output("–ó–∞–≥—Ä—É–∂–µ–Ω –ø—Ä–∏–º–µ—Ä –ø—Ä–æ–≥—Ä–∞–º–º—ã")

def clear_editor():
    """–û—á–∏—Å—Ç–∏—Ç—å —Ä–µ–¥–∞–∫—Ç–æ—Ä"""
    if js.confirm("–û—á–∏—Å—Ç–∏—Ç—å —Ä–µ–¥–∞–∫—Ç–æ—Ä –∫–æ–¥–∞?"):
        js.document.getElementById("code-editor").value = ""
        log_output("–†–µ–¥–∞–∫—Ç–æ—Ä –æ—á–∏—â–µ–Ω")

def assemble():
    """–ê—Å—Å–µ–º–±–ª–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É"""
    try:
        code = js.document.getElementById("code-editor").value.strip()
        
        if not code:
            js.alert("–†–µ–¥–∞–∫—Ç–æ—Ä –ø—É—Å—Ç!")
            return
        
        program_data = json.loads(code)
        
        if 'program' not in program_data:
            js.alert("JSON –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –ø–æ–ª–µ 'program'")
            return
        
        update_status("–ê—Å—Å–µ–º–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ...")
        log_output("–ù–∞—á–∞–ª–æ –∞—Å—Å–µ–º–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è...", clear=True)
        
        if not HAS_MODULES:
            log_output("(–î–µ–º–æ) –ü—Ä–æ–≥—Ä–∞–º–º–∞ —É—Å–ø–µ—à–Ω–æ –∞—Å—Å–µ–º–±–ª–∏—Ä–æ–≤–∞–Ω–∞")
            log_output("(–î–µ–º–æ) –°–æ–∑–¥–∞–Ω –±–∏–Ω–∞—Ä–Ω—ã–π —Ñ–∞–π–ª")
        else:
            assembler = UVMAssembler()
            intermediate = assembler.assemble_from_string(code)
            log_output(f"–ü—Ä–æ–≥—Ä–∞–º–º–∞ –∞—Å—Å–µ–º–±–ª–∏—Ä–æ–≤–∞–Ω–∞: {len(intermediate)} –∫–æ–º–∞–Ω–¥")
            
            log_output("\n–ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ:")
            for cmd in intermediate:
                log_output(f"  {cmd}")
        
        update_status("–ê—Å—Å–µ–º–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ")
        js.alert("–ü—Ä–æ–≥—Ä–∞–º–º–∞ —É—Å–ø–µ—à–Ω–æ –∞—Å—Å–µ–º–±–ª–∏—Ä–æ–≤–∞–Ω–∞!")
        
    except json.JSONDecodeError as e:
        js.alert(f"–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON:\n{str(e)}")
    except Exception as e:
        log_output(f"‚ùå –û—à–∏–±–∫–∞ –∞—Å—Å–µ–º–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è: {str(e)}")
        update_status("–û—à–∏–±–∫–∞ –∞—Å—Å–µ–º–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è")

def run():
    """–í—ã–ø–æ–ª–Ω–∏—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º—É"""
    try:
        update_status("–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã...")
        log_output("\n" + "="*50, clear=False)
        log_output("–ù–ê–ß–ê–õ–û –í–´–ü–û–õ–ù–ï–ù–ò–Ø –ü–†–û–ì–†–ê–ú–ú–´")
        log_output("="*50)
        
        if not HAS_MODULES:
            log_output("(–î–µ–º–æ) –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–≥—Ä–∞–º–º—ã...")
            log_output("(–î–µ–º–æ) –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥...")
            log_output("(–î–µ–º–æ) –ü—Ä–æ–≥—Ä–∞–º–º–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!")
            
            demo_dump = {
                "100": 42,
                "200": 100,
                "300": 25,
                "400": 5,
                "500": 10
            }
            
            update_memory(demo_dump)
            log_output(f"\n–î–ê–ú–ü –ü–ê–ú–Ø–¢–ò ({len(demo_dump)} –∑–Ω–∞—á–µ–Ω–∏–π)")
            
        else:
            interpreter = UVMInterpreter()
            
            # –î–µ–º–æ-–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–∞–º—è—Ç–∏
            test_data = {
                100: 25,
                200: 100,
                300: 144
            }
            
            for addr, value in test_data.items():
                interpreter.memory[addr] = value
            
            log_output("–ü–∞–º—è—Ç—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏")
            
            # –í –≤–µ–±-–≤–µ—Ä—Å–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º —É–ø—Ä–æ—â–µ–Ω–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
            code = js.document.getElementById("code-editor").value
            program_data = json.loads(code)
            
            for cmd in program_data['program']:
                if cmd['opcode'] == 'LOAD_CONST':
                    interpreter.acc = cmd['operand']
                    log_output(f"LOAD_CONST: ACC = {cmd['operand']}")
                elif cmd['opcode'] == 'STORE_MEM':
                    interpreter.memory[cmd['operand']] = interpreter.acc
                    log_output(f"STORE_MEM: MEM[{cmd['operand']}] = {interpreter.acc}")
                elif cmd['opcode'] == 'SQRT':
                    import math
                    value = interpreter.memory[interpreter.acc]
                    result = int(math.sqrt(abs(value)))
                    interpreter.memory[cmd['operand']] = result
                    log_output(f"SQRT: MEM[{cmd['operand']}] = ‚àö({value}) = {result}")
            
            # –ü–æ–ª—É—á–∞–µ–º –¥–∞–º–ø
            dump = {}
            for i in range(1000):
                if interpreter.memory[i] != 0:
                    dump[str(i)] = interpreter.memory[i]
            
            update_memory(dump)
            log_output(f"\n–î–ê–ú–ü –ü–ê–ú–Ø–¢–ò ({len(dump)} –∑–Ω–∞—á–µ–Ω–∏–π)")
        
        # –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –≤–∫–ª–∞–¥–∫—É –ø–∞–º—è—Ç–∏
        js.switchTab('memory')
        update_status("–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ")
        js.alert("–ü—Ä–æ–≥—Ä–∞–º–º–∞ —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞!")
        
    except Exception as e:
        log_output(f"\n‚ùå –û–®–ò–ë–ö–ê –í–´–ü–û–õ–ù–ï–ù–ò–Ø: {str(e)}")
        update_status("–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è")
        js.alert(f"–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:\n{str(e)}")

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
log_output("–£–í–ú Web –≤–µ—Ä—Å–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!", clear=True)
    </py-script>

    <script>
        function switchTab(tabName) {
            // –°–∫—Ä—ã—Ç—å –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // –ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é –≤–∫–ª–∞–¥–∫—É
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
        }
    </script>
</body>
</html>
